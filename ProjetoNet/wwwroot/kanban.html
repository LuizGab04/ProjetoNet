<!DOCTYPE html>
<html class="navbar-vertical-collapsed" lang="pt-br" dir="ltr">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- ===============================================-->
    <!--    Document Title-->
    <!-- ===============================================-->
    <title>Fabrica de Software | Kanbam</title>


    <!-- ===============================================-->
    <!--    Favicons-->
    <!-- ===============================================-->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">

    <meta name="theme-color" content="#ffffff">
    <script src="../assets/js/config.js"></script>
    <script src="../vendors/overlayscrollbars/OverlayScrollbars.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>



    <!-- ===============================================-->
    <!--    Stylesheets-->
    <!-- ===============================================-->
    <link href="../vendors/glightbox/glightbox.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700%7cPoppins:300,400,500,600,700,800,900&amp;display=swap" rel="stylesheet">
    <link href="../vendors/overlayscrollbars/OverlayScrollbars.min.css" rel="stylesheet">
    <link href="../assets/css/theme-rtl.min.css" rel="stylesheet" id="style-rtl">
    <link href="../assets/css/theme.min.css" rel="stylesheet" id="style-default">
    <link href="../assets/css/user-rtl.min.css" rel="stylesheet" id="user-style-rtl">
    <link href="../assets/css/user.min.css" rel="stylesheet" id="user-style-default">
    <script>
        var isRTL = JSON.parse(localStorage.getItem('isRTL'));
        if (isRTL) {
            var linkDefault = document.getElementById('style-default');
            var userLinkDefault = document.getElementById('user-style-default');
            linkDefault.setAttribute('disabled', true);
            userLinkDefault.setAttribute('disabled', true);
            document.querySelector('html').setAttribute('dir', 'rtl');
        } else {
            var linkRTL = document.getElementById('style-rtl');
            var userLinkRTL = document.getElementById('user-style-rtl');
            linkRTL.setAttribute('disabled', true);
            userLinkRTL.setAttribute('disabled', true);
        }</script>
    <style>
        #nomeUsuario {
            padding-top: 11px;
        }

        .kanban-items-container{
            min-height: 100px;
        }

        .kanban-container {
            position: relative;
            min-height: 200px;
        }

        .kanban-column-footer {
            position: relative;
            display: block !important;
        }

    </style>
</head>

<body class="overflow-auto">

    <!-- ===============================================-->
    <!--    Main Content-->
    <!-- ===============================================-->
    <main class="main" id="top">
        <div class="container-fluid" data-layout="container-fluid">
            <script>
                var isFluid = JSON.parse(localStorage.getItem('isFluid'));
                if (isFluid) {
                    var container = document.querySelector('[data-layout]');
                    container.classList.remove('container');
                    container.classList.add('container-fluid');
                }</script>
            <nav class="navbar navbar-light navbar-vertical navbar-expand-xl">
                <script>
                    var navbarStyle = localStorage.getItem("navbarStyle");
                    if (navbarStyle && navbarStyle !== 'transparent') {
                        document.querySelector('.navbar-vertical').classList.add(`navbar-${navbarStyle}`);
                    }</script>
            </nav>
            <div class="content">
                <nav class="navbar navbar-light navbar-glass navbar-top navbar-expand">
                    <ul class="navbar-nav navbar-nav-icons ms-auto flex-row align-items-center">
                        <li id="nomeUsuario">

                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link pe-0" id="navbarDropdownUser" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <div id="fotoUsuario" class="avatar avatar-xl">
                                </div>
                            </a>
                            <div class="dropdown-menu dropdown-menu-end py-0" aria-labelledby="navbarDropdownUser">
                                <div class="bg-white dark__bg-1000 rounded-2 py-2">
                                    <a id="configuracao" class="dropdown-item">Configuração</a>
                                    <a id="deslogar" class="dropdown-item" href="#">Deslogar</a>
                                </div>
                            </div>
                        </li>
                    </ul>
                </nav>
                <div class="row gx-0 kanban-header rounded-2 px-card py-2 mt-2 mb-3">
                    <div class="col d-flex align-items-center">
                        <h5 class="mb-0">Fabrica de Software</h5>
                        <div class="vertical-line vertical-line-400 position-relative h-100 mx-3"></div>
                    </div>
                    <div class="col-auto d-flex align-items-center">
                        <button class="btn btn-sm btn-falcon-default me-2 d-none d-md-block" data-bs-toggle="modal" data-bs-target="#modalSprint"><span class="fas fa-plus me-2"></span>Adicionar Sprint</button>
                    </div>
                </div>
                <div id="kanbanGridContainer">

                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modalSprint" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Cadastro da Sprint</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div>
                            <label for="nomeSprint" class="form-label">Nome da Sprint</label>
                            <input type="text" id="nomeSprint" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="cadastrarSprint" class="btn btn-primary">Adicionar Sprint</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- ===============================================-->
    <!--    End of Main Content-->
    <!-- ===============================================-->
    <!-- ===============================================-->
    <!--    JavaScripts-->
    <!-- ===============================================-->
    <script src="../vendors/popper/popper.min.js"></script>
    <script src="../vendors/bootstrap/bootstrap.min.js"></script>
    <script src="../vendors/anchorjs/anchor.min.js"></script>
    <script src="../vendors/is/is.min.js"></script>
    <script src="../vendors/glightbox/glightbox.min.js"></script>
    <script src="vendors/draggable/draggable.bundle.legacy.js"></script>
    <script src="../vendors/fontawesome/all.min.js"></script>
    <script src="../vendors/lodash/lodash.min.js"></script>
    <script src="../vendors/list.js/list.min.js"></script>
    <script src="../assets/js/theme.js"></script>
   
    <script type="module">
        import { Usuario } from "../Modelos/ModeloUsuario.js"
        import { Sprint } from "../Modelos/ModeloSprint.js"
        import { Card } from "../Modelos/ModeloCard.js"


        const loadPage = async () => {
            // Parte 1
            await Usuario.pegarFoto()
            const token = localStorage.getItem("token");
            const nome = localStorage.getItem("nome_usuario")
            document.getElementById("nomeUsuario").innerHTML = `<p>Olá, ${nome}!</p>`
            if (!token) {
                window.location.href = "login.html";
                return
            }

            const sprints = await Sprint.carregarTodasAsSprints()
            for (const sprint of sprints) {
                await Card.mostrarCards(sprint.id_sprint)
            }

            // Parte 2
            const cadastrarSprint = document.getElementById("cadastrarSprint");
            const excluirSprint = document.getElementById("excluirSprint")

            cadastrarSprint.onclick = async () => {
                const nome = document.getElementById("nomeSprint").value

                if (!nome) {
                    Swal.fire({
                        title: "Preencha os campos vazios",
                        icon: "warning"
                    });
                    return;
                }

                const sprint = {
                    nome_sprint: nome
                };

                const resposta = await Sprint.cadastrarSprint(sprint);

                if (!resposta) {
                    await Sprint.carregarSprint(sprint);
                    document.getElementById("kanbanGridContainer").innerHTML = "";
                    await Sprint.carregarTodasAsSprints()
                    await Card.mostrarCards(sprint.id_sprint)
                    draggableInit();
                    Swal.fire({
                        title: "Sucesso!",
                        text: "Sprint Cadastrada.",
                        icon: "success"
                    });
                } else {
                    Swal.fire({
                        title: "Erro!",
                        text: "Ocorreu um erro ao cadastrar a sprint.",
                        icon: "error"
                    });
                }
                for (const sprint of sprints) {
                    await Card.mostrarCards(sprint.id_sprint)
                }
            };
            draggableInit();

            document.addEventListener("click", async (event) => {
                const e = event
                // Verifica se clicou num botão com classe "btnRemoverSprint"
                if (e.target.classList.contains("btnRemoverSprint")) {
                    const sprintDiv = e.target.closest(".kanban-container");
                    const idSprint = sprintDiv?.getAttribute("data-id");

                    if (!idSprint) return;

                    const confirmacao = await Swal.fire({
                        title: "Tem certeza?",
                        text: "Essa ação não poderá ser desfeita!",
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Sim, excluir",
                        cancelButtonText: "Cancelar"
                    });

                    if (confirmacao.isConfirmed) {
                        const resposta = await Sprint.excluirSprint(idSprint);

                        if (resposta.ok) {
                            sprintDiv.remove()// Remove do DOM
                            Swal.fire("Sprint excluída com sucesso!", "", "success");
                        } else {
                            Swal.fire("Erro ao excluir", "", "error");
                        }
                    }
                }

                // Mostrar o formulário ao clicar em "Add another card"
                if (event.target.closest(".btn-add-card")) {
                    const coluna = event.target.closest(".kanban-column");
                    const formulario = coluna.querySelector(".add-card-form");
                    formulario.classList.remove("d-none");
                    formulario.classList.add("d-block")
                }

                // Ocultar o formulário ao clicar em "Cancel"
                if (event.target.dataset.btnForm === "hide") {
                    const formulario = event.target.closest(".add-card-form");
                    formulario.classList.add("d-none")
                }

                // Adicionar o card ao clicar em "Add card"
                if (event.target.classList.contains("btCadastrarCard")) {
                    const coluna = event.target.closest(".kanban-column");
                    const form = event.target.closest(".add-card-form");
                    const sprintDiv = event.target.closest(".kanban-container");
                    const id_sprint = sprintDiv?.getAttribute("data-id");
                    const nomeCard = coluna.querySelector(".input-nome-card").value;

                    if (!nomeCard) {
                        Swal.fire({
                            title: "Preencha o nome do card",
                            icon: "warning"
                        });
                        return;
                    }

                    const card = {
                        sprint_responsavel: id_sprint,
                        nome_card: nomeCard
                    };

                    console.log(card)

                    const resposta = await Card.cadastrarCard(card);
                    console.log(id_sprint)

                    form.querySelector(".input-nome-card").value = ""; // limpa input

                    // ✅ Atualiza visualmente os cards dessa sprint
                    await Card.mostrarCards(id_sprint);
                }
            });

            function draggableInit() {
                const sortable = new Draggable.Sortable(
                    document.querySelectorAll('.kanban-items-container'),
                    {
                        draggable: '.kanban-item'
                    }
                );

                sortable.on('sortable:stop', function (evt) {
                    const el = evt.data.dragEvent.source;
                    const columnContainer = el.closest('.kanban-items-container');
                    const form = columnContainer.querySelector('.add-card-form');

                    if (form && !el.nextElementSibling) {
                        columnContainer.appendChild(form);
                    }
                });

                sortable.on('sortable:sorted', async function (evt) {
                    const el = evt.data.dragEvent.source;
                    const columnContainer = evt.data.newContainer.closest('.kanban-column');
                    const novaColuna = parseInt(columnContainer.getAttribute('column-index'));
                    const id_sprint = parseInt(columnContainer.closest('.kanban-container').getAttribute('data-id'));
                    const id_card = el.dataset.id;
                    const wrapper = el.closest('.sortable-item-wrapper');
                    const nomeCardElement = wrapper ? wrapper.querySelector('.nome-card') : null;
                    const nomeCard = nomeCardElement ? nomeCardElement.textContent.trim() : null;



                    console.log("Nome do card:", nomeCard);

                    const cardAtualizado = {
                        nome_card: nomeCard,
                        id_card: id_card,
                        sprint_responsavel: id_sprint,
                        coluna_responsavel: novaColuna
                    };

                    console.log("Card atualizado via Sortable:", cardAtualizado);
                    await Card.atualizarCard(cardAtualizado);
                });
            }

            deslogar.onclick = () => {
                localStorage.removeItem("token")
                localStorage.removeItem("nome_usuario")
                localStorage.removeItem("foto_perfil")
                window.location.href = "login.html"
            }
            configuracao.onclick = () => {
                window.location.href = "configuracao.html"
            }

        }

        await loadPage()
    </script>
</body>

</html>